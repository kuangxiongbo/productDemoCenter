# 中文路径问题分析

## 问题现象

- ✅ 根目录 `sv/` 编译成功，效果正常
- ✅ `test/` 目录编译成功，效果正常
- ❌ `基础设施业务线/sv/` 目录编译后无法正常显示内容

## 问题定位

### 1. URL 编码/解码问题

浏览器访问中文路径时：
- **URL 会被编码**：`基础设施业务线` → `%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E4%B8%9A%E5%8A%A1%E7%BA%BF`
- **`window.location.pathname` 返回解码后的路径**：`/基础设施业务线/sv/dist/`

### 2. 服务器端路径处理

**当前实现**（server.js 第 90-100 行）：
```javascript
const pathParts = req.path.split('/').filter(p => p);
for (let i = pathParts.length; i > 0; i--) {
  const testPath = '/' + pathParts.slice(0, i).join('/');
  const projectPath = path.join(__dirname, testPath.substring(1));
  // ...
}
```

**问题**：
- `req.path` 在 Express 中已经是**解码后的路径**（Express 自动解码）
- 文件系统路径使用**原始中文**（UTF-8）
- 两者应该能匹配，但可能存在编码不一致的问题

### 3. getBasePath 函数问题

**服务器端注入的 `window.getBasePath`**（server.js 第 342-380 行）：
```javascript
window.getBasePath = function getBasePath() {
  const currentPath = window.location.pathname; // 解码后的路径：/基础设施业务线/sv/dist/
  // ...
  if (currentPath.includes('/dist/')) {
    const distIndex = currentPath.indexOf('/dist/');
    return currentPath.substring(0, distIndex + 5); // 返回：/基础设施业务线/sv/dist/
  }
  // ...
}
```

**configureProjectRoutes 添加的 `getBasePath`**（server.js 第 3492-3516 行）：
```javascript
function getBasePath() {
  const currentPath = window.location.pathname;
  // 相同的逻辑
}
```

**潜在问题**：
- `window.location.pathname` 返回的是**解码后的中文路径**
- 但编译后的资源路径（如 `/基础设施业务线/sv/dist/assets/index.js`）在 HTML 中是**原始中文**
- 浏览器在请求资源时，可能会对中文路径进行编码
- 如果服务器端路径匹配使用的是编码后的路径，可能导致不匹配

## 解决方案

### 方案一：确保路径编码一致性（推荐）

1. **服务器端路径匹配**：确保 `req.path` 和文件系统路径都使用相同的编码
2. **getBasePath 函数**：返回的路径应该与编译后的资源路径一致（都使用原始中文或都使用编码）

### 方案二：在 getBasePath 中处理编码

确保 `getBasePath` 返回的路径与浏览器实际请求的路径一致：
- 如果浏览器请求时使用编码路径，`getBasePath` 也应该返回编码路径
- 如果浏览器请求时使用原始中文，`getBasePath` 也应该返回原始中文

### 方案三：统一使用 URL 编码

在编译时和运行时都使用 URL 编码的路径，确保一致性。

## 需要检查的点

1. **浏览器实际请求的路径**：打开浏览器开发者工具，查看 Network 面板，检查实际请求的 URL 是编码还是解码
2. **服务器端日志**：检查 `req.path` 的值是编码还是解码
3. **编译后的 HTML**：检查资源路径是原始中文还是编码
4. **Vue Router base 配置**：检查 `createWebHistory` 的 base 参数是否正确

## 下一步

1. 检查浏览器 Network 面板，查看实际请求的 URL
2. 检查服务器端日志，查看 `req.path` 的值
3. 对比根目录 `sv` 和嵌套目录 `基础设施业务线/sv` 的请求差异
4. 修复路径编码/解码不一致的问题

