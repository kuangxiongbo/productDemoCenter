# 嵌套目录路径支持说明

## 问题描述

当 Git 同步的项目不在根目录，而是在嵌套目录中时（如 `/密码服务业务线/统一密码服务平台/`），之前的路径匹配逻辑只支持根目录项目（如 `/项目名/`），导致无法正确访问。

## 解决方案

### 已实现的修复

1. **路径匹配逻辑更新**（server.js 第 52-117 行）
   - 支持嵌套目录匹配：从最长路径开始尝试，找到包含 `dist` 目录的项目
   - 支持路径如：`/密码服务业务线/统一密码服务平台/`
   - 自动计算相对路径（相对于服务器根目录）

2. **资源路径修复更新**（server.js 第 183-210 行）
   - 使用完整的相对路径修复资源路径
   - 例如：`/密码服务业务线/统一密码服务平台/dist/assets/`
   - 而不是只使用项目名：`/统一密码服务平台/dist/assets/`

3. **basename 计算更新**（server.js 第 251-264 行）
   - `getBasePath()` 函数支持嵌套路径
   - 自动识别完整路径，如 `/密码服务业务线/统一密码服务平台/dist/`
   - 确保 React Router 的 basename 配置正确

## 访问方式

### 嵌套目录项目

如果项目在嵌套目录中，例如：
```
/密码服务业务线/统一密码服务平台/
```

访问方式：
```
http://localhost:3000/密码服务业务线/统一密码服务平台/
http://localhost:3000/密码服务业务线/统一密码服务平台/dist/
http://localhost:3000/密码服务业务线/统一密码服务平台/dist/index.html
```

### 根目录项目

如果项目在根目录，例如：
```
/us-cryptography-service-platform/
```

访问方式：
```
http://localhost:3000/us-cryptography-service-platform/
http://localhost:3000/us-cryptography-service-platform/dist/
http://localhost:3000/us-cryptography-service-platform/dist/index.html
```

## 工作原理

### 路径匹配流程

1. **接收请求**：如 `/密码服务业务线/统一密码服务平台/`
2. **路径分解**：`['密码服务业务线', '统一密码服务平台']`
3. **从最长路径开始尝试**：
   - 尝试 `/密码服务业务线/统一密码服务平台/` → 检查是否有 `dist` 目录
   - 如果找到，使用该路径
   - 如果未找到，尝试 `/密码服务业务线/` → 检查是否有 `dist` 目录
   - 继续尝试，直到找到或遍历完所有路径

4. **计算相对路径**：
   - 从服务器根目录到项目目录的相对路径
   - 例如：`密码服务业务线/统一密码服务平台`

5. **修复资源路径**：
   - 使用相对路径：`/密码服务业务线/统一密码服务平台/dist/assets/`

6. **计算 basename**：
   - 使用完整路径：`/密码服务业务线/统一密码服务平台/dist/`

## 测试验证

### 测试步骤

1. **查找嵌套目录中的项目**：
   ```bash
   find . -type d -name "dist" | grep -v node_modules
   ```

2. **访问嵌套目录项目**：
   ```
   http://localhost:3000/父目录/子目录/项目名/
   ```

3. **检查资源路径**：
   - 打开浏览器开发者工具
   - 查看 Network 标签
   - 确认资源文件路径正确（如 `/父目录/子目录/项目名/dist/assets/...`）

4. **检查 basename**：
   - 打开浏览器控制台
   - 执行：`window.__REACT_ROUTER_BASENAME__`
   - 应该显示正确的 basename（如 `/父目录/子目录/项目名/dist/`）

## 优势

1. ✅ **支持任意嵌套深度**：可以处理任意层级的目录结构
2. ✅ **自动路径计算**：无需手动配置，自动识别项目路径
3. ✅ **资源路径正确**：所有资源文件路径自动修复
4. ✅ **路由配置正确**：React Router basename 自动配置

## 注意事项

1. **路径匹配顺序**：从最长路径开始匹配，确保优先匹配嵌套目录
2. **相对路径计算**：使用 `path.relative(__dirname, projectPath)` 计算相对路径
3. **URL 编码**：中文目录名会自动进行 URL 编码

## 总结

服务器已支持嵌套目录路径，无论项目在哪个目录层级，都能正确访问：
- ✅ 自动识别项目路径
- ✅ 自动修复资源路径
- ✅ 自动配置路由 basename
- ✅ 支持任意嵌套深度


