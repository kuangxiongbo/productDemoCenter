# 编译方案说明

## 问题1：编译后的文件是否可以直接访问？是否一定需要动态注入？

### 答案：**编译时配置是最佳方案，动态注入是兜底方案**

### 1. 编译时配置（推荐方案）⭐⭐⭐⭐⭐

**原理**：在构建前自动配置 `vite.config.js` 的 `base` 属性，统一使用 **相对路径 `./`**，构建后资源路径就是相对路径，由外层平台挂载路径。

**优点**：
- ✅ 性能最优：不需要服务器端处理
- ✅ 符合标准做法：资源路径在构建时就是正确的
- ✅ 不需要动态注入：编译后的文件可以直接访问
- ✅ 兼容性好：适用于所有支持 `base` 配置的构建工具

**当前实现（已按“相对路径方案”优化）**：
- `configureProjectRoutes` 函数会自动修改所有 Vite 项目的 `vite.config.js`，统一设置：`base: './'`
- 构建后的 HTML 中资源路径为相对路径：`./assets/index.js`

**验证**：
查看 `基础设施业务线/sv/dist/index.html`：
```html
<script type="module" crossorigin src="./assets/index-BXrwFA6m.js"></script>
```
资源路径已经是相对路径，浏览器会在当前目录下解析为 `/基础设施业务线/sv/dist/assets/index-BXrwFA6m.js`，**可以直接访问，不需要额外路径修复**。

### 2. 动态注入（兜底方案）⭐⭐⭐

**原理**：服务器端拦截 HTML 请求，动态注入修复脚本。

**使用场景**：
- 已编译好的项目（编译时未正确配置 base）
- 编译时配置失败的情况
- 需要兼容已存在的 dist 目录

**缺点**：
- ⚠️ 需要服务器端处理（性能影响很小）
- ⚠️ 每次请求都需要处理（但可以缓存）

**当前实现**：
- 路由修复中间件（server.js）仍然存在，主要作用有两点：
  - 兜底修复老的 **绝对路径 / 相对路径配置不正确的 dist**
  - 为 Vue / React 等前端路由自动注入 `window.getBasePath`，修正 `basename` / `history base`
- **对已经按 `base: './'` 重新编译的项目，不再依赖它做资源路径修复，只用于路由 base 兜底**

### 3. 结论

**最佳实践**：
1. **优先使用编译时配置**：在 Git 同步后，自动调用 `configureProjectRoutes` 配置路由（Vite 统一改为 `base: './'`）
2. **然后执行构建**：`npm run build` 使用正确的 base 配置
3. **编译后的文件可以直接访问**：资源路径已经是正确的相对路径，挂载在哪个子目录都能正常工作
4. **动态注入作为兜底**：如果编译时配置失败，服务器端会自动注入修复脚本

**当前状态**：
- ✅ `vite.config.js` 已正确配置 `base: '/基础设施业务线/sv/dist/'`
- ✅ 构建后的 HTML 中资源路径是绝对路径
- ✅ **可以直接访问，不需要动态注入**

---

## 问题2：是否还有其他前端项目支持？是否有遗漏？

### 当前支持的前端框架

#### 1. 已支持的项目类型（PROJECT_DETECTORS）

| 框架 | 检测方式 | 构建输出目录 | 路由配置支持 | 状态 |
|------|---------|------------|------------|------|
| **React** | `package.json` + `react` 依赖 | `build`, `dist` | ✅ BrowserRouter | ✅ 已支持 |
| **Vue** | `package.json` + `vue` 依赖 | `dist` | ✅ Vue Router | ✅ 已支持 |
| **Angular** | `angular.json` + `package.json` | `dist` | ✅ baseHref + RouterModule | ✅ 已支持 |
| **Next.js** | `package.json` + `next` 依赖 | `.next` | ✅ basePath | ✅ 已支持 |
| **Svelte** | `package.json` + `svelte` 依赖 | `dist`, `build` | ✅ paths.base | ✅ 已支持 |
| **Nuxt.js** | `package.json` + `nuxt` 依赖 | `.output`, `dist` | ✅ base | ✅ 已支持 |
| **Node.js** | `package.json` | `dist`, `build` | ❌ 不适用 | ✅ 已支持 |
| **Static** | `index.html` | `.` | ❌ 不适用 | ✅ 已支持 |

#### 2. 路由配置支持情况

**已完整支持**：
- ✅ **React + React Router**：自动配置 `BrowserRouter` 的 `basename`
- ✅ **Vue + Vue Router**：自动配置 `createWebHistory` 的 `base`
- ✅ **Angular**：自动配置 `angular.json` 的 `baseHref` 和 `app-routing.module.ts` 的 `RouterModule`
- ✅ **Next.js**：自动配置 `next.config.js` 的 `basePath`
- ✅ **SvelteKit**：自动配置 `svelte.config.js` 的 `paths.base`
- ✅ **Nuxt.js**：自动配置 `nuxt.config.js` 的 `base`

### 3. 已实现的路由配置

#### Angular 路由配置 ✅

**自动修改的文件**：
- `angular.json`：自动设置所有项目的 `baseHref`
- `src/app/app-routing.module.ts`：自动配置 `RouterModule.forRoot()` 的 `useHash: false` 和 `baseHref`

**实现逻辑**：
- 遍历 `angular.json` 中的所有项目，设置 `architect.build.options.baseHref`
- 修改 `app-routing.module.ts`，确保使用 `useHash: false` 并设置 `baseHref`

#### Next.js 路由配置 ✅

**自动修改的文件**：
- `next.config.js` / `next.config.mjs` / `next.config.ts`：自动添加或更新 `basePath`

**实现逻辑**：
- 支持 CommonJS (`module.exports`) 和 ES6 (`export default`) 格式
- 自动检测并更新 `basePath` 配置

#### SvelteKit 路由配置 ✅

**自动修改的文件**：
- `svelte.config.js` / `svelte.config.ts`：自动配置 `kit.paths.base`

**实现逻辑**：
- 在 `kit` 对象中添加或更新 `paths.base` 配置
- 如果不存在 `kit` 配置，会自动创建

#### Nuxt.js 路由配置 ✅

**自动修改的文件**：
- `nuxt.config.js` / `nuxt.config.ts`：自动添加或更新 `base`

**实现逻辑**：
- 支持 CommonJS 和 ES6 格式
- 自动检测并更新 `base` 配置

### 4. 实现总结

#### ✅ 已实现的框架支持

所有主流前端框架的路由配置已完整实现：

1. **React + Vite**：`vite.config.js` 的 `base: './'` + `App.jsx` 的 `BrowserRouter` `basename`
2. **Vue + Vite**：`vite.config.js` 的 `base: './'` + `router/index.js` 的 `createWebHistory` `base`
3. **Angular**：`angular.json` 的 `baseHref` + `app-routing.module.ts` 的 `RouterModule`
4. **Next.js**：`next.config.js` 的 `basePath`
5. **SvelteKit**：`svelte.config.js` 的 `kit.paths.base`
6. **Nuxt.js**：`nuxt.config.js` 的 `base`

#### 配置流程

```
Git 同步
  ↓
检测项目类型（PROJECT_DETECTORS）
  ↓
安装依赖（npm install）
  ↓
自动配置路由（configureProjectRoutes）
  ├─ React/Vue: vite.config.js + Router 配置
  ├─ Angular: angular.json + app-routing.module.ts
  ├─ Next.js: next.config.js
  ├─ SvelteKit: svelte.config.js
  └─ Nuxt.js: nuxt.config.js
  ↓
构建项目（npm run build）
  ↓
完成（编译后的文件可直接访问）
```

### 5. 当前兼容性总结

**完全兼容**（编译时配置 + 可直接访问）：
- ✅ React + Vite + React Router
- ✅ Vue + Vite + Vue Router
- ✅ Angular + Angular Router
- ✅ Next.js
- ✅ SvelteKit
- ✅ Nuxt.js

**完全兼容**（不需要路由配置）：
- ✅ 纯静态项目
- ✅ Node.js 后端项目

### 6. 使用说明

#### 自动配置流程

1. **Git 同步项目**：系统会自动检测项目类型
2. **自动安装依赖**：如果检测到 `package.json`，自动执行 `npm install`
3. **自动配置路由**：根据项目类型，自动修改相应的配置文件
4. **自动构建项目**：执行 `npm run build`，使用正确的 base 配置
5. **直接访问**：编译后的文件可以直接访问，资源路径已正确配置

#### 配置示例

**React 项目**：
- `vite.config.js`: `base: './'`
- `App.jsx`: `basename={getBasePath()}`，其中 `getBasePath` 从 `window.location.pathname` 自动推导出 `/父目录/项目名/dist/`

**Vue 项目**：
- `vite.config.js`: `base: './'`
- `router/index.js`: 使用 `createWebHistory((typeof window !== 'undefined' && window.getBasePath && typeof window.getBasePath === 'function') ? window.getBasePath() : '')`，由平台注入的 `window.getBasePath` 自动适配挂载子路径

**Angular 项目**：
- `angular.json`: `baseHref` 仍使用绝对路径 `/项目路径/dist/`（Angular 官方推荐方式）
- `app-routing.module.ts`: `RouterModule.forRoot(routes, { useHash: false })`

**Next.js 项目**：
- `next.config.js`: `basePath: '/项目路径/dist/'`（Next 只支持绝对 basePath）

**SvelteKit 项目**：
- `svelte.config.js`: `kit: { paths: { base: '/项目路径/dist/' } }`

**Nuxt.js 项目**：
- `nuxt.config.js`: `base: '/项目路径/dist/'`

### 7. 优势

1. **全自动**：无需手动配置，Git 同步后自动完成所有配置
2. **全兼容**：支持所有主流前端框架
3. **高性能**：编译时配置，无需运行时处理
4. **向后兼容**：已编译好的项目可通过动态注入正常工作

