# 服务器自动路径修复说明

## 功能说明

服务器已实现**自动路径修复功能**，无需重新构建项目即可解决 dist 目录的路径问题。

## 修复内容

### 1. 资源路径修复

**问题**：访问 `/项目名/` 或 `/项目名/dist/index.html` 时，HTML 中的相对路径（如 `./assets/index.js`）可能无法正确解析。

**解决方案**：服务器自动将相对路径转换为绝对路径
- `./assets/` → `/项目名/dist/assets/`
- `./vite.svg` → `/项目名/dist/vite.svg`

### 2. React Router basename 修复

**问题**：React Router 的 `basename` 配置不正确，导致路由无法匹配。

**解决方案**：自动注入路由修复脚本
- 动态计算正确的 `basename`
- Hook `React.createElement` 自动修复 `BrowserRouter` 的 `basename`
- 处理 `/index.html` 到 `/` 的重定向

## 访问方式

### 方式一：项目根目录访问（推荐）

```
http://localhost:3000/us-cryptography-service-platform/
```

**自动处理**：
- ✅ 服务 `dist/index.html` 内容
- ✅ 修复资源路径
- ✅ 注入路由修复代码

### 方式二：直接访问 dist 目录

```
http://localhost:3000/us-cryptography-service-platform/dist/
http://localhost:3000/us-cryptography-service-platform/dist/index.html
```

**自动处理**：
- ✅ 修复资源路径（如果需要）
- ✅ 注入路由修复代码

## 实现位置

### 中间件 1：项目根目录服务（server.js 第 52-125 行）

- 检测项目根目录访问
- 标记需要修复路径的请求

### 中间件 2：路由修复（server.js 第 109-309 行）

- 修复资源路径
- 注入路由修复脚本
- 处理所有 dist/index.html 请求

## 修复流程

```
1. 用户访问 /项目名/ 或 /项目名/dist/index.html
   ↓
2. 服务器检测请求
   ↓
3. 读取 dist/index.html
   ↓
4. 修复资源路径（相对路径 → 绝对路径）
   ↓
5. 注入路由修复脚本
   ↓
6. 返回修复后的 HTML
```

## 验证方法

### 1. 检查资源路径修复

```bash
curl -s "http://localhost:3000/us-cryptography-service-platform/dist/index.html" | grep -E "(href|src)"
```

应该看到：
- `href="/us-cryptography-service-platform/dist/assets/..."`
- `src="/us-cryptography-service-platform/dist/assets/..."`

### 2. 检查路由修复代码注入

```bash
curl -s "http://localhost:3000/us-cryptography-service-platform/dist/index.html" | grep "__ROUTE_FIX_INJECTED__"
```

应该看到：`__ROUTE_FIX_INJECTED__`

### 3. 检查资源文件可访问

```bash
curl -I "http://localhost:3000/us-cryptography-service-platform/dist/assets/index-*.js"
```

应该返回：`200 OK`

## 优势

1. ✅ **无需重新构建**：服务器端自动处理
2. ✅ **自动应用**：所有项目自动生效
3. ✅ **路径正确**：资源路径和路由都正确
4. ✅ **向后兼容**：不影响现有访问方式

## 注意事项

1. **需要重启服务器**：修改代码后需要重启服务器才能生效
2. **缓存问题**：如果浏览器缓存了旧的 HTML，需要清除缓存
3. **性能影响**：每次请求都会处理 HTML（可以添加缓存优化）

## 故障排查

### 问题：页面仍然是空白

**可能原因**：
1. 服务器未重启
2. 浏览器缓存了旧的 HTML
3. 资源文件不存在

**解决方法**：
1. 重启服务器
2. 清除浏览器缓存（Ctrl+Shift+R 或 Cmd+Shift+R）
3. 检查浏览器控制台的错误信息

### 问题：资源文件 404

**可能原因**：
1. 资源路径修复失败
2. 文件名不匹配

**解决方法**：
1. 检查服务器日志，查看是否有路径修复日志
2. 检查 dist/assets 目录中的实际文件名
3. 确认 HTML 中的文件名与实际文件名匹配

## 总结

服务器已实现完整的自动路径修复功能，包括：
- ✅ 资源路径修复
- ✅ React Router basename 修复
- ✅ 自动注入修复代码

**无需重新构建项目，服务器会自动处理所有路径问题。**

