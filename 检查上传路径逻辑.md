# 上传文件夹路径保存逻辑检查报告

## 1. 前端传递的路径信息

### 1.1 文件路径传递
- **位置**: `script.js` - `setupUploadForm` 函数
- **方式**: 
  ```javascript
  formData.append('files', file, relativePath);
  formData.append('filePaths', JSON.stringify(filePaths));
  ```
- **内容**: 
  - `file.originalname` = `relativePath` (如: "folderName/subfolder/file.html")
  - `filePaths` = 所有文件的完整相对路径数组

### 1.2 目录路径传递
- **位置**: `script.js` - `setupUploadForm` 函数
- **方式**: 
  ```javascript
  formData.append('directoryPaths', JSON.stringify(Array.from(directoryPaths)));
  ```
- **内容**: 所有需要创建的目录路径（如: ["sub1", "sub1/sub2"]）

## 2. 后端接收的路径信息

### 2.1 Multer 接收
- **位置**: `server.js` - `multer.diskStorage.destination`
- **接收内容**:
  - `file.originalname`: 包含完整相对路径（前端通过 `formData.append` 的第三个参数设置）
  - `req.body.filePaths`: JSON 字符串，包含所有文件的完整相对路径
  - `req.body.directoryPaths`: JSON 字符串，包含所有需要创建的目录路径

### 2.2 文件保存
- **位置**: `server.js` - `/api/upload` 端点
- **保存信息**:
  ```javascript
  const uploadedFiles = req.files.map(file => ({
    name: file.filename,           // 保存后的文件名（不包含路径）
    path: file.path,               // 保存后的绝对路径
    size: file.size,
    originalName: file.originalname // ✅ 原始文件名（包含完整相对路径）
  }));
  ```

## 3. 版本记录中的路径信息

### 3.1 版本快照保存
- **位置**: `server.js` - `recordVersionChange` 函数
- **保存内容**:
  ```javascript
  details: {
    files: uploadedFiles  // ✅ 包含 originalName（原始相对路径）
  }
  ```

### 3.2 文件备份
- **位置**: `server.js` - `backupFile` 函数
- **备份信息**:
  ```javascript
  return {
    originalPath: filePath,        // 保存后的绝对路径
    relativePath: relativePath,    // 相对于项目根目录的路径
    backupPath: backupPath         // 备份文件路径
  };
  ```
- **问题**: ⚠️ 备份时使用的是保存后的绝对路径，而不是原始上传时的相对路径

## 4. 恢复逻辑中的路径使用

### 4.1 文件恢复
- **位置**: `server.js` - `restoreFileFromBackup` 函数
- **恢复逻辑**:
  ```javascript
  const targetPath = backedFile.originalPath;  // 使用保存后的绝对路径
  ```
- **问题**: ⚠️ 恢复时使用保存后的绝对路径，如果文件夹被重命名，可能无法正确恢复

## 5. 发现的问题

### 5.1 路径信息保存不完整
- ✅ **已保存**: `originalName` 在 `uploadedFiles` 中保存了原始相对路径
- ❌ **未使用**: 备份和恢复时使用的是保存后的绝对路径，而不是原始相对路径
- ⚠️ **风险**: 如果上传的文件夹被重命名或移动，恢复时可能无法找到正确的文件位置

### 5.2 建议改进
1. **在备份时保存原始相对路径**:
   ```javascript
   const backupInfo = backupFile(fileInfo.path, versionId);
   backupInfo.originalRelativePath = fileInfo.originalName; // 保存原始相对路径
   ```

2. **在恢复时使用原始相对路径**:
   ```javascript
   // 如果存在原始相对路径，使用它来恢复文件
   if (backedFile.originalRelativePath) {
     const targetPath = path.join(__dirname, backedFile.originalRelativePath);
   }
   ```

## 6. 当前逻辑总结

### 6.1 路径信息流向
```
前端上传
  ↓
file.originalname (原始相对路径: "folderName/subfolder/file.html")
  ↓
Multer 接收并保存到服务器
  ↓
file.path (保存后的绝对路径: "/path/to/folderName/subfolder/file.html")
  ↓
uploadedFiles 数组保存 originalName (原始相对路径) ✅
  ↓
版本记录保存 uploadedFiles ✅
  ↓
备份文件使用 file.path (保存后的绝对路径) ⚠️
  ↓
恢复时使用 backedFile.originalPath (保存后的绝对路径) ⚠️
```

### 6.2 结论
- ✅ **原文件路径已保存**: `originalName` 在版本记录中保存了原始相对路径
- ⚠️ **但未完全使用**: 备份和恢复时使用的是保存后的绝对路径
- ⚠️ **潜在问题**: 如果文件夹被重命名，恢复时可能无法正确恢复文件位置

